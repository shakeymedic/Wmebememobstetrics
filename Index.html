<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WMEBEM | Obstetric Emergencies</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- CORE CSS --- */
        :root {
            --bg-body: #f3f4f6; --text-main: #1f2937; --text-muted: #6b7280;
            --bg-card: #ffffff; --border-color: #e5e7eb;
            --primary: #2563eb; --primary-hover: #1d4ed8; --primary-light: #eff6ff;
            --danger: #dc2626; --danger-light: #fef2f2;
            --success: #16a34a; --warning: #f59e0b; --warning-light: #fffbeb;
            --info-bg: #e0f2fe; --info-text: #0c4a6e;
        }
        .dark {
            --bg-body: #0f172a; --text-main: #f3f4f6; --text-muted: #9ca3af;
            --bg-card: #1e293b; --border-color: #374151;
            --primary: #3b82f6; --primary-light: #1e3a8a;
            --danger-light: #450a0a; --warning-light: #451a03;
            --info-bg: #172554; --info-text: #bfdbfe;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background: var(--bg-body); color: var(--text-main); font-size: 16px; line-height: 1.5; padding-bottom: 100px; }
        
        /* Layout */
        .container { max-width: 800px; margin: 0 auto; padding: 0 1rem; }
        .flex { display: flex; } .flex-col { flex-direction: column; } .items-center { align-items: center; } .justify-between { justify-content: space-between; } .gap-2 { gap: 0.5rem; }
        .hidden { display: none !important; } .block { display: block; }
        .w-full { width: 100%; } .p-4 { padding: 1rem; } .mb-4 { margin-bottom: 1rem; } .mt-2 { margin-top: 0.5rem; } .text-sm { font-size: 0.875rem; } .font-bold { font-weight: 700; }
        
        /* Components */
        .card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 0.75rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); overflow: hidden; }
        .btn { cursor: pointer; display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; border: 1px solid transparent; font-size: 0.9rem; transition: all 0.2s; text-decoration: none; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border-color: var(--border-color); color: var(--text-main); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 0.25rem 0.75rem; font-size: 0.8rem; }
        
        /* Grid Menu */
        .grid-menu { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; padding: 1rem 0; }
        .menu-item { background: var(--bg-card); border: 1px solid var(--border-color); padding: 1rem; border-radius: 0.75rem; text-align: center; cursor: pointer; font-weight: 600; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; min-height: 80px; }
        .menu-item:active { transform: scale(0.98); background: var(--primary-light); }

        /* Inputs */
        input[type="text"], textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; background: var(--bg-body); color: var(--text-main); font-family: inherit; font-size: 1rem; }

        /* Header */
        header { position: sticky; top: 0; z-index: 50; background: var(--bg-card); border-bottom: 1px solid var(--border-color); padding: 0.75rem 0; }
        .logo { height: 40px; width: auto; margin-right: 0.75rem; }
        
        /* Accordions */
        details { border-bottom: 1px solid var(--border-color); background: var(--bg-card); }
        details:last-child { border-bottom: none; }
        details summary { padding: 1rem; cursor: pointer; list-style: none; display: flex; align-items: center; font-weight: 500; }
        details summary::-webkit-details-marker { display: none; }
        details[open] summary { background: rgba(0,0,0,0.02); font-weight: 700; color: var(--primary); }
        .checkbox { width: 1.5rem; height: 1.5rem; margin-right: 1rem; accent-color: var(--success); flex-shrink: 0; }

        /* Info Box */
        .info-box { background: var(--info-bg); color: var(--info-text); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border-left: 4px solid var(--primary); font-size: 0.9rem; }
        .info-title { font-weight: 700; display: block; margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.75rem; opacity: 0.8; }

        /* Widgets */
        .timer-box { background: var(--danger); color: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center; margin-bottom: 1rem; }
        .timer-display { font-family: monospace; font-size: 3rem; font-weight: 700; line-height: 1; margin: 0.5rem 0; }
        
        /* FAB */
        .fab-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 100; display: flex; flex-direction: column; align-items: flex-end; pointer-events: none; }
        .fab-btn { pointer-events: auto; width: 3.5rem; height: 3.5rem; border-radius: 50%; background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }
        .fab-menu { opacity: 0; transform: translateY(10px); transition: all 0.2s; pointer-events: none; margin-bottom: 1rem; display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end; }
        .fab-container:hover .fab-menu, .fab-menu:hover { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .fab-item { background: var(--bg-card); color: var(--text-main); padding: 0.5rem 1rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid var(--border-color); font-size: 0.875rem; cursor: pointer; }

        /* Modals */
        dialog { border: none; border-radius: 1rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); padding: 0; max-width: 95vw; width: 600px; background: var(--bg-card); color: var(--text-main); }
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        
        /* SVG Flowchart */
        .flow-box { fill: var(--primary-light); stroke: var(--primary); stroke-width: 2px; rx: 8px; }
        .flow-text { font-family: sans-serif; font-size: 14px; fill: var(--text-main); text-anchor: middle; font-weight: 600; }
        .flow-arrow { stroke: var(--text-muted); stroke-width: 2px; marker-end: url(#arrowhead); }
        .dark .flow-box { fill: #1e3a8a; stroke: #60a5fa; }
        .dark .flow-text { fill: white; }
        .dark .flow-arrow { stroke: #94a3b8; }
    </style>
</head>
<body>

    <dialog id="disclaimer-modal">
        <div class="p-4 border-b" style="border-color: var(--border-color)">
            <h2 style="margin:0; font-size:1.25rem;">Clinical Disclaimer</h2>
        </div>
        <div class="p-4">
            <p>This application is an <strong>educational aide-m√©moire</strong> for qualified medical professionals.</p>
            <p class="mt-2 font-bold text-danger">DOES NOT replace clinical judgment. Use at your own risk. Check local trust guidelines.</p>
        </div>
        <div class="p-4 bg-gray-50 dark:bg-gray-800">
            <button class="btn btn-primary w-full" onclick="acceptDisclaimer()">I Accept</button>
        </div>
    </dialog>

    <header>
        <div class="container">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo" class="logo" onclick="showHome()">
                    <div>
                        <div style="font-weight: 700; font-size:1.1rem; line-height: 1.2;">WMEBEM</div>
                        <div id="page-title" class="text-sm text-muted">Obs Emergencies</div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="header-back-btn" class="hidden btn btn-outline btn-sm" onclick="showHome()">Back</button>
                    <button class="btn btn-outline btn-sm" onclick="openSettings()">#</button>
                </div>
            </div>
            <div id="numbers-bar" class="mt-2 flex gap-2 text-xs"></div>
        </div>
    </header>

    <main class="container mt-2">
        <div id="view-index">
            <input type="text" id="search-bar" placeholder="Search protocols..." class="mb-4">
            <div class="grid-menu" id="grid-container"></div>
        </div>

        <div id="view-protocol" class="hidden">
            <div id="content-area"></div>
        </div>
    </main>

    <div class="fab-container">
        <div class="fab-menu">
            <div class="card p-4 mb-2 hidden" id="fab-timer-widget" style="width: 200px;">
                <div class="flex justify-between mb-2"><strong>Timer</strong> <span style="cursor:pointer" onclick="toggleFabWidget()">‚úï</span></div>
                <div id="fab-timer-display" style="font-family:monospace; font-size:2rem; text-align:center;">00:00</div>
                <button class="btn btn-success w-full" id="fab-timer-btn" onclick="runFabTimer()">Start</button>
            </div>
            <button class="fab-item" onclick="toggleFabWidget()">‚è±Ô∏è General Timer</button>
            <button class="fab-item" onclick="copyLog()">üìã Copy Log</button>
            <button class="fab-item" onclick="toggleDark()">üåô Toggle Dark</button>
        </div>
        <button class="fab-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
        </button>
    </div>

    <dialog id="algo-modal">
        <div class="p-4 flex justify-between items-center border-b" style="border-color: var(--border-color);">
            <h3 style="margin:0" id="algo-title">Algorithm</h3>
            <button class="btn btn-outline" onclick="document.getElementById('algo-modal').close()">‚úï</button>
        </div>
        <div class="p-4" style="overflow-x: auto; text-align: center; background: var(--bg-card);" id="algo-content"></div>
    </dialog>

    <dialog id="settings-modal">
        <div class="p-4">
            <h3>Emergency Numbers</h3>
            <div class="flex flex-col gap-4 mt-2">
                <input type="text" id="set-crash" placeholder="Crash Call (e.g. 2222)">
                <input type="text" id="set-obs" placeholder="Obs Reg (e.g. Bleep 1234)">
                <div class="flex justify-end gap-2 mt-2">
                    <button class="btn btn-outline" onclick="document.getElementById('settings-modal').close()">Close</button>
                    <button class="btn btn-primary" onclick="saveSettings()">Save</button>
                </div>
            </div>
        </div>
    </dialog>

    <script>
    // --- FULL DATASET WITH EXPANDED INFO & LINKS ---
    const protocols = [
        {
            id: 'afe',
            name: 'Amniotic Fluid Embolism',
            bg: "Rare, unpredictable, catastrophic collapse. Occurs during labour or immediately postpartum. Diagnosis of exclusion. RCOG GTG 56.",
            dx: "Triad: 1. Sudden hypoxia, 2. Hypotension, 3. Coagulopathy (DIC). Premonitory symptoms: numbness, agitation, 'pins and needles', sense of doom.",
            steps: ['Call Help (2222)', 'CPR + LUD', 'Intubate', 'MHP (Fibrinogen)', 'Perimortem Section'],
            checklist: [
                'Recognise: Collapse + Hypoxia + Coagulopathy',
                'Call 2222: Obstetric Emergency + Cardiac Arrest',
                'Start CPR + Left Uterine Displacement (LUD)',
                'Secure Airway: Intubate early (aspiration risk)',
                'Activate MHP: Early FFP, Cryoprecipitate, Fibrinogen',
                'Consider: TXA 1g IV',
                'If Cardiac Arrest: Delivery within 5 mins',
                'Consider Recombinant Factor VIIa if refractory'
            ],
            links: [
                { title: 'RCOG GTG 56: Maternal Collapse', url: 'https://www.rcog.org.uk/guidance/browse-all-guidance/green-top-guidelines/maternal-collapse-in-pregnancy-and-the-puerperium-green-top-guideline-no-56/' }
            ]
        },
        {
            id: 'abruption',
            name: 'Placental Abruption',
            bg: "Premature separation of placenta. 'Concealed' or 'Revealed'. Risk factors: Pre-eclampsia, Trauma, Previous Abruption, Smoking, Cocaine.",
            dx: "Constant pain, 'woody' hard uterus, vaginal bleeding (may be absent), fetal distress. Maternal shock out of proportion to visible loss.",
            steps: ['Assess (Pain/Bleeding)', 'Resus (IV x2)', 'FBC/Coag/G&S', 'CTG', 'Deliver'],
            checklist: [
                'Call Senior Help immediately',
                'Maternal Resus: ABCDE, 2x Grey Cannulas',
                'Bloods: FBC, G&S, Coag, Fibrinogen (<2g/L is significant)',
                'Continuous CTG (if fetal heart present)',
                'Pain relief (Opiates usually required)',
                'Anti-D if Rh Negative',
                'Expedite Delivery (Cat 1 CS if fetal distress)'
            ],
            links: [
                { title: 'RCOG GTG 63: Antepartum Haemorrhage', url: 'https://www.rcog.org.uk/guidance/browse-all-guidance/green-top-guidelines/antepartum-haemorrhage-green-top-guideline-no-63/' }
            ]
        },
        {
            id: 'torsion',
            name: 'Ovarian Torsion',
            bg: "Rotation of ovary on pedicle. Time-critical. Risk factors: Ovarian Mass >5cm, Pregnancy, IVF.",
            dx: "Acute, severe, unilateral pelvic pain. Vomiting (very common). Mild pyrexia. USS: Enlarged ovary, 'whirlpool sign', free fluid.",
            steps: ['Analgesia/Antiemetics', 'Pregnancy Test', 'Gynae Review', 'Laparoscopy'],
            checklist: [
                'Analgesia (NSAIDs/Opiates) + Antiemetics',
                'Pregnancy Test (Exclude Ectopic)',
                'Keep NBM (Preparation for Theatre)',
                'Urgent Gynae Referral',
                'Laparoscopy (Detorsion usually possible even if appears necrotic)'
            ],
            links: [
                { title: 'RCOG GTG 62: Ovarian Masses', url: 'https://www.rcog.org.uk/guidance/browse-all-guidance/green-top-guidelines/management-of-suspected-ovarian-masses-in-premenopausal-women-green-top-guideline-no-62/' }
            ]
        },
        {
            id: 'pid',
            name: 'Severe PID / TOA',
            bg: "Ascending infection. BASHH Guidelines 2019/24. Risks: Multiple partners, young age, recent instrumentation.",
            dx: "Bilateral lower abdo pain, deep dyspareunia, discharge. O/E: Cervical excitation, adnexal tenderness. Fever suggests severe/TOA.",
            steps: ['Sepsis Screen', 'Swabs (NAAT)', 'Antibiotics', 'Admit vs Discharge'],
            checklist: [
                'Pregnancy Test (Essential)',
                'Swabs: Endocervical/Vaginal NAAT (GC/Chlamydia) + MC&S',
                'Outpatient Rx: IM Ceftriaxone 1g + Doxy 100mg BD (14d) + Metro 400mg BD (14d)',
                'Inpatient Rx (Severe): IV Ceftriaxone 2g OD + IV Doxy + IV Metro',
                'Consider TOA if severe/sepsis: Requires Imaging (USS/CT)'
            ],
            links: [
                { title: 'BASHH PID Guidelines', url: 'https://www.bashh.org/guidelines' }
            ]
        },
        {
            id: 'preeclampsia',
            name: 'Pre-eclampsia / Eclampsia',
            bg: "New HTN >20w with proteinuria or end-organ dysfunction. NICE NG133.",
            dx: "BP >140/90. Severe if >160/110. Symptoms: Headache, Visual disturbance, Epigastric pain, Clonus.",
            steps: ['Call Help', 'Seizure: MgSO4', 'BP Control', 'Fluid Restrict', 'Deliver'],
            checklist: [
                'Call 2222 if Eclamptic Seizure',
                'Airway/Breathing: High flow O2',
                'Seizure: MgSO4 4g IV Loading (over 5-10m) then 1g/hr',
                'Recurrent Seizure: Further 2g MgSO4 IV',
                'BP Control (Target 135/85): Oral Nifedipine / IV Labetalol / IV Hydralazine',
                'Fluid Restriction: 80ml/hr total input',
                'Urgent Delivery Plan'
            ],
            links: [
                { title: 'NICE NG133: Hypertension in Pregnancy', url: 'https://www.nice.org.uk/guidance/ng133' }
            ]
        },
        {
            id: 'ectopic',
            name: 'Ruptured Ectopic',
            bg: "Implantation outside uterus. Rupture = Life Threatening Haemorrhage. NICE NG126.",
            dx: "+ve hCG + Pain + Shoulder tip pain + Shock. Diarrhoea/Vomiting common.",
            steps: ['Resus (ABC)', 'Crossmatch', 'Gynae + Anaes', 'Theatre'],
            checklist: [
                'Recognise: Shock + Positive Pregnancy Test',
                'Call Gynae + Anaesthetics STAT',
                'Activate Massive Haemorrhage Protocol',
                'IV Access x2 Grey/Orange',
                'Do NOT delay for Ultrasound if haemodynamically unstable',
                'Transfer directly to Theatre (Laparotomy/Laparoscopy)'
            ],
            links: [
                { title: 'NICE NG126: Ectopic Pregnancy', url: 'https://www.nice.org.uk/guidance/ng126' }
            ]
        },
        {
            id: 'pph',
            name: 'Post Partum Haemorrhage',
            bg: "Primary PPH: >500ml within 24h. 4 Ts: Tone (70%), Trauma, Tissue, Thrombin. RCOG GTG 52.",
            dx: "Visible bleeding or instability. 'Boggy' uterus.",
            steps: ['Call Help', 'Massage', 'Drugs', 'Manouevres', 'Theatre'],
            checklist: [
                'Call 2222 if >1000ml or Shock',
                'Lie Flat + O2 + 2x Cannulae + Bloods',
                'Mechanical: Fundal Massage + Bimanual Compression',
                'Drug 1: Syntometrine IM (if no BP issues) or Syntocinon 5IU IV',
                'Drug 2: Tranexamic Acid 1g IV',
                'Drug 3: Carboprost 250mcg IM (rep every 15m, max 8 doses)',
                'Drug 4: Misoprostol 800-1000mcg PR',
                'Surgical: Balloon tamponade / B-Lynch / Hysterectomy'
            ],
            widget: 'pph',
            links: [
                { title: 'RCOG GTG 52: PPH', url: 'https://www.rcog.org.uk/guidance/browse-all-guidance/green-top-guidelines/postpartum-haemorrhage-prevention-and-management-green-top-guideline-no-52/' }
            ]
        },
        {
            id: 'cord',
            name: 'Cord Prolapse',
            bg: "Cord descends below presenting part. Vasospasm/Compression = Hypoxia. RCOG GTG 50.",
            dx: "Cord palpable/visible. Fetal bradycardia.",
            steps: ['Call Help', 'Elevate Head', 'Position', 'Bladder Fill', 'Section'],
            checklist: [
                'Call Help (Cat 1 Section)',
                'Digital: Gloved hand in vagina to lift head off cord (KEEP HAND IN)',
                'Position: Knee-chest or Head down (Trendelenburg)',
                'Bladder Filling: 500-700ml 0.9% Saline via catheter (clamp catheter)',
                'Tocolysis: Terbutaline 250mcg SC',
                'Transport to theatre immediately'
            ],
            links: [
                { title: 'RCOG GTG 50: Cord Prolapse', url: 'https://www.rcog.org.uk/guidance/browse-all-guidance/green-top-guidelines/umbilical-cord-prolapse-green-top-guideline-no-50/' }
            ]
        },
        {
            id: 'shoulder',
            name: 'Shoulder Dystocia',
            bg: "Ant shoulder impacts pubic symphysis. 'Turtle Sign'. Bone emergency. RCOG GTG 42.",
            dx: "Failure of restitution. Standard traction fails.",
            steps: ['Call Help', 'McRoberts', 'Suprapubic', 'Internal Manoeuvres', 'Roll'],
            checklist: [
                'Call Help (Anaes + Paeds). Stop Pushing. Flat bed.',
                'McRoberts: Flex hips hyperflexed against abdomen (resolves 90%)',
                'Suprapubic Pressure: Constant or rocking (CPR style) behind anterior shoulder',
                'Internal: Episiotomy (for access)',
                'Rubin II / Woods Screw / Reverse Woods Screw',
                'Remove Posterior Arm: Grasp wrist, sweep across face',
                'Roll: All Fours (Gaskin)'
            ],
            widget: 'dystocia',
            links: [
                { title: 'RCOG GTG 42: Shoulder Dystocia', url: 'https://www.rcog.org.uk/guidance/browse-all-guidance/green-top-guidelines/shoulder-dystocia-green-top-guideline-no-42/' }
            ]
        },
        {
            id: 'breech',
            name: 'Breech Birth (Unexpected)',
            bg: "Buttocks/feet presenting. High risk of head entrapment. RCOG GTG 20b.",
            dx: "Meconium, palpable cleft.",
            steps: ['Call Help', 'Hands Off', 'Legs', 'Arms', 'Head'],
            checklist: [
                'Call Senior Help (Obs + Paeds)',
                'Hands OFF until umbilicus visible',
                'Delivery of Legs: Pinard Manoeuvre (abduct thigh, flex knee)',
                'Delivery of Arms: Lovset\'s Manoeuvre (rotate 180 deg)',
                'Delivery of Head: Mauriceau-Smellie-Veit (Jaw flexion, shoulder traction)',
                'ENTRAPMENT: Incise cervix (D√ºhrssen) or Symphysiotomy'
            ],
            links: [
                { title: 'RCOG GTG 20b: Breech Presentation', url: 'https://www.rcog.org.uk/guidance/browse-all-guidance/green-top-guidelines/management-of-breech-presentation-green-top-guideline-no-20b/' }
            ]
        },
        {
            id: 'cardiac',
            name: 'Obstetric Cardiac Arrest',
            bg: "Maternal collapse. Aortocaval compression reduces CO by 30%. Resus Council UK.",
            dx: "Unresponsive, Apnoeic. Causes: 4Hs 4Ts + Eclampsia, AFE, Intracranial.",
            steps: ['Call 2222', 'CPR + LUD', 'Airway', 'Hysterotomy <4min', 'Deliver <5min'],
            checklist: [
                'Call 2222 (Obs + Adult Cardiac Arrest)',
                'Manual Left Uterine Displacement (LUD)',
                'CPR: 30:2 (Compressions higher on sternum)',
                'Airway: Intubate early (ETCO2 monitoring)',
                'IV Access: Above diaphragm (SVC)',
                '4 Minute Rule: Start Perimortem CS (no anaesthetic)',
                '5 Minute Rule: Deliver fetus'
            ],
            widget: 'cardiac',
            links: [
                { title: 'Resus Council UK: Maternal Arrest', url: 'https://www.resus.org.uk/library/2021-resuscitation-guidelines/special-circumstances-guidelines' }
            ]
        }
    ];

    // --- APP STATE ---
    let currentId = null;
    let logs = {};
    let pphVol = 0;

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        renderIndex();
        
        // Search Listener
        document.getElementById('search-bar').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.menu-item').forEach(btn => {
                const name = btn.textContent.toLowerCase();
                btn.style.display = name.includes(term) ? 'flex' : 'none';
            });
        });

        // Checkbox Listener
        document.getElementById('content-area').addEventListener('change', (e) => {
            if(e.target.matches('.checkbox')) {
                const msg = e.target.getAttribute('data-msg');
                const action = e.target.checked ? '[DONE]' : '[UNDO]';
                logAction(currentId, `${action} ${msg}`);
            }
        });

        loadSettings();
        if(!localStorage.getItem('wmebem_accepted')) document.getElementById('disclaimer-modal').showModal();
        if(localStorage.getItem('wmebem_dark') === 'true') document.body.classList.add('dark');
    });

    // --- VIEW MANAGEMENT ---
    function showHome() {
        document.getElementById('view-index').classList.remove('hidden');
        document.getElementById('view-protocol').classList.add('hidden');
        document.getElementById('header-back-btn').classList.add('hidden');
        document.getElementById('page-title').textContent = 'Obs Emergencies';
        currentId = null;
    }

    function renderIndex() {
        const grid = document.getElementById('grid-container');
        grid.innerHTML = '';
        protocols.forEach(p => {
            const btn = document.createElement('div');
            btn.className = 'menu-item';
            btn.textContent = p.name;
            btn.onclick = () => loadProtocol(p.id);
            grid.appendChild(btn);
        });
    }

    // --- PROTOCOL RENDERER ---
    function loadProtocol(id) {
        currentId = id;
        const p = protocols.find(x => x.id === id);
        
        // Switch Views
        document.getElementById('view-index').classList.add('hidden');
        document.getElementById('view-protocol').classList.remove('hidden');
        document.getElementById('header-back-btn').classList.remove('hidden');
        document.getElementById('page-title').textContent = p.name;

        // Render Widgets
        let widgetHtml = '';
        if(p.widget === 'pph') widgetHtml = renderPPHWidget();
        if(p.widget === 'dystocia') widgetHtml = renderDystociaWidget();
        if(p.widget === 'cardiac') widgetHtml = renderCardiacWidget();

        // Render Checklists
        const checklistHtml = p.checklist.map((item, idx) => `
            <details>
                <summary>
                    <input type="checkbox" class="checkbox" data-msg="${item}">
                    <span>${item}</span>
                </summary>
                <div class="p-4 text-sm bg-gray-50 dark:bg-gray-800" style="padding-left: 3.5rem;">
                    Action logged.
                </div>
            </details>
        `).join('');

        // Render Links
        let linksHtml = '';
        if(p.links) {
            linksHtml = `<div class="card p-4 mb-4">
                <h4 class="font-bold text-sm text-muted mb-2">GUIDELINES</h4>
                ${p.links.map(l => `<a href="${l.url}" target="_blank" class="btn btn-outline btn-sm w-full mb-2" style="justify-content:space-between">${l.title} <span>‚Üó</span></a>`).join('')}
            </div>`;
        }

        // Inject Content
        const area = document.getElementById('content-area');
        area.innerHTML = `
            <div class="info-box">
                <span class="info-title">Background</span>
                <div class="mb-2">${p.bg}</div>
                <span class="info-title">Diagnosis / Signs</span>
                <div>${p.dx}</div>
            </div>
            ${widgetHtml}
            <div class="card mb-4">
                <div class="p-4 flex justify-between items-center border-b" style="border-color:var(--border-color)">
                    <h2 class="font-bold">Action Checklist</h2>
                    <button class="btn btn-primary btn-sm" onclick="showAlgo('${id}')">Algorithm</button>
                </div>
                ${checklistHtml}
            </div>
            ${linksHtml}
            <div class="card p-4">
                <h4 class="font-bold text-sm text-muted mb-2">SESSION LOG</h4>
                <textarea id="log-area" class="h-40" readonly>${getLogText(id)}</textarea>
            </div>
        `;
    }

    // --- WIDGETS ---
    function renderPPHWidget() {
        return `
        <div class="card p-4 mb-4" style="background:var(--danger-light); border-color:var(--danger);">
            <div class="flex justify-between items-end mb-2">
                <div><div class="text-xs font-bold text-danger uppercase">Total Blood Loss</div><div class="text-3xl font-mono font-bold text-danger" id="pph-total">${pphVol} ml</div></div>
                <button class="btn btn-outline btn-sm bg-white" onclick="resetPPH()">Reset</button>
            </div>
            <div class="flex gap-2">
                <button class="btn bg-white w-full border-danger text-danger" onclick="addPPH(100)">+100</button>
                <button class="btn btn-danger w-full font-bold" onclick="addPPH(500)">+500ml</button>
            </div>
        </div>`;
    }
    
    function renderDystociaWidget() {
        return `
        <div class="card p-4 mb-4 bg-warning-light border-warning">
             <div class="flex justify-between items-center">
                <div><div class="text-xs font-bold text-warning-dark uppercase">Head-to-Body Interval</div><div id="dystocia-time" class="text-2xl font-mono font-bold">00:00</div></div>
                <button id="btn-dystocia" class="btn btn-primary" onclick="toggleDystocia()">Start Timer</button>
             </div>
        </div>`;
    }

    function renderCardiacWidget() {
        return `
        <div class="timer-box">
            <div class="text-xs opacity-80 uppercase tracking-widest">Hysterotomy Timer</div>
            <div id="cardiac-time" class="timer-display">04:00</div>
            <div class="flex justify-center gap-2 mt-2">
                <button id="btn-cardiac" class="btn bg-white text-danger font-bold" onclick="toggleCardiac()">START</button>
                <button class="btn btn-outline text-white border-white hover:bg-white/10" onclick="resetCardiac()">Reset</button>
            </div>
        </div>`;
    }

    // --- LOGIC FUNCTIONS ---
    function logAction(id, msg) {
        if(!id) return;
        if(!logs[id]) logs[id] = [];
        const time = new Date().toTimeString().substring(0,5);
        logs[id].push(`[${time}] ${msg}`);
        const area = document.getElementById('log-area');
        if(area) { area.value = logs[id].join('\n'); area.scrollTop = area.scrollHeight; }
    }
    function getLogText(id) { return (logs[id] || []).join('\n'); }
    function copyLog() { 
        let txt = '';
        if (currentId) {
            txt = `Protocol: ${currentId.toUpperCase()}\n` + getLogText(currentId);
        } else {
            Object.keys(logs).forEach(k => { txt += `--- ${k.toUpperCase()} ---\n${logs[k].join('\n')}\n\n` });
        }
        navigator.clipboard.writeText(txt).then(() => alert('Log Copied!')); 
    }

    // PPH
    function addPPH(n) { pphVol += n; document.getElementById('pph-total').textContent = pphVol + ' ml'; logAction('pph', `EBL Updated: ${pphVol}ml (+${n})`); }
    function resetPPH() { pphVol = 0; document.getElementById('pph-total').textContent = '0 ml'; logAction('pph', 'EBL Reset'); }

    // Dystocia
    let dysInt, dysSec = 0;
    function toggleDystocia() {
        const btn = document.getElementById('btn-dystocia');
        if(btn.textContent.includes('Start')) {
            btn.textContent = 'Stop'; btn.className = 'btn btn-danger';
            logAction('shoulder', 'Head Delivered. Timer Started.');
            dysInt = setInterval(() => { dysSec++; document.getElementById('dystocia-time').textContent = fmtTime(dysSec); }, 1000);
        } else {
            clearInterval(dysInt); btn.textContent = 'Start Timer'; btn.className = 'btn btn-primary';
            logAction('shoulder', 'Body Delivered. Interval: ' + fmtTime(dysSec)); dysSec = 0;
        }
    }

    // Cardiac
    let carInt, carSec = 240;
    function toggleCardiac() {
        const btn = document.getElementById('btn-cardiac');
        if(btn.textContent === 'START') {
            initAudio(); btn.textContent = 'STOP'; logAction('cardiac', 'Cardiac Timer STARTED');
            carInt = setInterval(() => {
                carSec--; document.getElementById('cardiac-time').textContent = fmtTime(carSec);
                if(carSec === 30) beep(440);
                if(carSec === 0) { beep(880); clearInterval(carInt); logAction('cardiac', '4 MINUTE LIMIT REACHED'); }
            }, 1000);
        } else { clearInterval(carInt); btn.textContent = 'START'; logAction('cardiac', 'Timer PAUSED'); }
    }
    function resetCardiac() { clearInterval(carInt); carSec = 240; document.getElementById('cardiac-time').textContent = '04:00'; document.getElementById('btn-cardiac').textContent = 'START'; }

    // Fab Timer
    let fabInt, fabSec = 0;
    function toggleFabWidget() { document.getElementById('fab-timer-widget').classList.toggle('hidden'); }
    function runFabTimer() {
        const btn = document.getElementById('fab-timer-btn');
        if(btn.textContent === 'Start') {
            btn.textContent = 'Stop'; btn.className = 'btn btn-danger w-full';
            fabInt = setInterval(() => { fabSec++; document.getElementById('fab-timer-display').textContent = fmtTime(fabSec); }, 1000);
        } else { clearInterval(fabInt); fabSec = 0; btn.textContent = 'Start'; btn.className = 'btn btn-success w-full'; document.getElementById('fab-timer-display').textContent = '00:00'; }
    }

    // Algorithm SVG
    function showAlgo(id) {
        const p = protocols.find(x => x.id === id);
        const steps = p.steps;
        const modal = document.getElementById('algo-modal');
        const content = document.getElementById('algo-content');
        document.getElementById('algo-title').textContent = p.name + " Algorithm";

        const boxH = 50; const boxW = 220; const gap = 40;
        const svgH = (steps.length * (boxH + gap)) + 20;
        
        let svg = `<svg width="300" height="${svgH}" viewBox="0 0 300 ${svgH}" xmlns="http://www.w3.org/2000/svg">`;
        svg += `<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" class="flow-arrow" fill="currentColor" /></marker></defs>`;
        
        steps.forEach((step, i) => {
            const y = 20 + (i * (boxH + gap));
            svg += `<rect x="40" y="${y}" width="${boxW}" height="${boxH}" class="flow-box" />`;
            svg += `<text x="150" y="${y + 30}" class="flow-text">${step}</text>`;
            if (i < steps.length - 1) {
                svg += `<line x1="150" y1="${y + boxH}" x2="150" y2="${y + boxH + gap}" class="flow-arrow" />`;
            }
        });
        svg += `</svg>`;
        content.innerHTML = svg;
        modal.showModal();
    }

    // Utilities
    function fmtTime(s) { return new Date(s * 1000).toISOString().substring(14, 19); }
    let audioCtx; function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function beep(f) { if(audioCtx) { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value = f; o.start(); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5); o.stop(audioCtx.currentTime + 0.5); } }

    function openSettings() { document.getElementById('settings-modal').showModal(); }
    function saveSettings() {
        localStorage.setItem('wmebem_nums', JSON.stringify({ crash: document.getElementById('set-crash').value, obs: document.getElementById('set-obs').value }));
        loadSettings(); document.getElementById('settings-modal').close();
    }
    function loadSettings() {
        const d = JSON.parse(localStorage.getItem('wmebem_nums') || '{}');
        document.getElementById('set-crash').value = d.crash || ''; document.getElementById('set-obs').value = d.obs || '';
        const b = document.getElementById('numbers-bar'); b.innerHTML = '';
        if(d.crash) b.innerHTML += `<span style="background:#fecaca; color:#7f1d1d; padding:2px 6px; border-radius:4px;">Crash: ${d.crash}</span>`;
        if(d.obs) b.innerHTML += `<span style="background:#bfdbfe; color:#1e3a8a; padding:2px 6px; border-radius:4px;">Obs: ${d.obs}</span>`;
    }
    function toggleDark() { document.body.classList.toggle('dark'); localStorage.setItem('wmebem_dark', document.body.classList.contains('dark')); }
    function acceptDisclaimer() { localStorage.setItem('wmebem_accepted', 'true'); document.getElementById('disclaimer-modal').close(); }
    </script>
</body>
</html>
