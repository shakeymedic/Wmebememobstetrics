<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WMEBEM | Obstetric Emergencies (Complete)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- CORE CSS --- */
        :root {
            --bg-body: #f3f4f6; --text-main: #1f2937; --text-muted: #6b7280;
            --bg-card: #ffffff; --border-color: #e5e7eb;
            --primary: #2563eb; --primary-hover: #1d4ed8; --primary-light: #eff6ff;
            --danger: #dc2626; --danger-light: #fef2f2;
            --success: #16a34a; --warning: #f59e0b; --warning-light: #fffbeb;
        }
        .dark {
            --bg-body: #0f172a; --text-main: #f3f4f6; --text-muted: #9ca3af;
            --bg-card: #1e293b; --border-color: #374151;
            --primary: #3b82f6; --primary-light: #1e3a8a;
            --danger-light: #450a0a; --warning-light: #451a03;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background: var(--bg-body); color: var(--text-main); font-size: 16px; line-height: 1.5; padding-bottom: 100px; }
        
        /* Layout */
        .container { max-width: 1024px; margin: 0 auto; padding: 0 1rem; }
        .flex { display: flex; } .flex-col { flex-direction: column; } .items-center { align-items: center; } .justify-between { justify-content: space-between; } .gap-2 { gap: 0.5rem; }
        .hidden { display: none !important; } .block { display: block; }
        .w-full { width: 100%; } .p-4 { padding: 1rem; } .mb-4 { margin-bottom: 1rem; } .mt-2 { margin-top: 0.5rem; }
        
        /* Components */
        .card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 0.75rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); overflow: hidden; }
        .btn { cursor: pointer; display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; border: 1px solid transparent; font-size: 0.875rem; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border-color: var(--border-color); color: var(--text-muted); }
        .btn-danger { background: var(--danger); color: white; }
        
        /* Inputs */
        input[type="text"], textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; background: var(--bg-body); color: var(--text-main); font-family: inherit; font-size: 1rem; }

        /* Header */
        header { position: sticky; top: 0; z-index: 50; background: var(--bg-card); border-bottom: 1px solid var(--border-color); backdrop-filter: blur(8px); padding: 0.75rem 0; opacity: 0.98; }

        /* Navigation */
        .nav-scroll { overflow-x: auto; white-space: nowrap; padding-bottom: 0.5rem; -ms-overflow-style: none; scrollbar-width: none; }
        .nav-scroll::-webkit-scrollbar { display: none; }
        .nav-btn { display: inline-block; padding: 0.5rem 1rem; margin-right: 0.5rem; border-radius: 99px; border: 1px solid var(--border-color); color: var(--text-muted); background: var(--bg-card); font-size: 0.875rem; transition: all 0.2s; }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Accordions */
        details { border: 1px solid var(--border-color); border-radius: 0.5rem; background: var(--bg-body); margin-bottom: 0.5rem; overflow: hidden; }
        details summary { padding: 0.75rem; cursor: pointer; list-style: none; display: flex; align-items: center; font-weight: 500; }
        details summary::-webkit-details-marker { display: none; }
        details[open] summary { border-bottom: 1px solid var(--border-color); background: rgba(0,0,0,0.02); }
        .summary-arrow { margin-left: auto; transition: transform 0.2s; }
        details[open] .summary-arrow { transform: rotate(90deg); }
        .checkbox { width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; accent-color: var(--success); }

        /* Widgets */
        .timer-box { background: var(--danger); color: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center; margin-bottom: 1rem; }
        .timer-display { font-family: monospace; font-size: 3rem; font-weight: 700; line-height: 1; margin: 0.5rem 0; }
        
        /* FAB */
        .fab-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 100; display: flex; flex-direction: column; align-items: flex-end; pointer-events: none; }
        .fab-btn { pointer-events: auto; width: 3.5rem; height: 3.5rem; border-radius: 50%; background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }
        .fab-menu { opacity: 0; transform: translateY(10px); transition: all 0.2s; pointer-events: none; margin-bottom: 1rem; display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end; }
        .fab-container:hover .fab-menu, .fab-menu:hover { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .fab-item { background: var(--bg-card); color: var(--text-main); padding: 0.5rem 1rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid var(--border-color); font-size: 0.875rem; cursor: pointer; }

        /* Modals */
        dialog { border: none; border-radius: 1rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); padding: 0; max-width: 95vw; width: 600px; background: var(--bg-card); color: var(--text-main); }
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        
        /* SVG Flowchart Styles */
        .flow-box { fill: var(--primary-light); stroke: var(--primary); stroke-width: 2px; rx: 8px; }
        .flow-text { font-family: sans-serif; font-size: 14px; fill: var(--text-main); text-anchor: middle; font-weight: 600; }
        .flow-arrow { stroke: var(--text-muted); stroke-width: 2px; marker-end: url(#arrowhead); }
        .dark .flow-box { fill: #1e3a8a; stroke: #60a5fa; }
        .dark .flow-text { fill: white; }
        .dark .flow-arrow { stroke: #94a3b8; }
    </style>
</head>
<body>

    <dialog id="disclaimer-modal">
        <div class="p-4 border-b" style="border-color: var(--border-color)">
            <h2 style="margin:0; font-size:1.25rem;">Clinical Disclaimer</h2>
        </div>
        <div class="p-4">
            <p>This application is an <strong>educational aide-m√©moire</strong> for qualified medical professionals.</p>
            <p class="mt-2 font-bold text-danger">DOES NOT replace clinical judgment. Use at your own risk.</p>
        </div>
        <div class="p-4 bg-gray-50 dark:bg-gray-800">
            <button class="btn btn-primary w-full" onclick="acceptDisclaimer()">I Accept</button>
        </div>
    </dialog>

    <header>
        <div class="container">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <img src="https://iili.io/KGQOvkl.md.png" alt="Logo" style="height: 32px; width: auto;">
                    <span style="font-weight: 700;">Obs Emergencies</span>
                </div>
                <div class="flex items-center gap-2">
                    <div id="numbers-bar" style="font-size: 0.75rem; display: flex; gap: 0.5rem;"></div>
                    <button class="btn btn-outline" style="padding: 0.5rem;" onclick="openSettings()">‚öôÔ∏è</button>
                    <button class="btn btn-outline" style="padding: 0.5rem;" onclick="toggleDark()">üåô</button>
                </div>
            </div>
            
            <input type="text" id="search-bar" placeholder="Search (e.g., 'Sepsis', 'Cord')..." class="mb-3">
            
            <div class="nav-scroll" id="nav-container"></div>
        </div>
    </header>

    <main class="container mt-2">
        <div id="content-area"></div>
    </main>

    <div class="fab-container">
        <div class="fab-menu">
            <div class="card p-4 mb-2 hidden" id="fab-timer-widget" style="width: 200px;">
                <div class="flex justify-between mb-2"><strong>Timer</strong> <span style="cursor:pointer" onclick="toggleFabWidget()">‚úï</span></div>
                <div id="fab-timer-display" style="font-family:monospace; font-size:2rem; text-align:center;">00:00</div>
                <button class="btn btn-success w-full" id="fab-timer-btn" onclick="runFabTimer()">Start</button>
            </div>
            <button class="fab-item" onclick="toggleFabWidget()">‚è±Ô∏è Timer</button>
            <button class="fab-item" onclick="copyLog()">üìã Copy Log</button>
        </div>
        <button class="fab-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
        </button>
    </div>

    <dialog id="algo-modal">
        <div class="p-4 flex justify-between items-center border-b" style="border-color: var(--border-color);">
            <h3 style="margin:0" id="algo-title">Algorithm</h3>
            <button class="btn btn-outline" onclick="document.getElementById('algo-modal').close()">‚úï</button>
        </div>
        <div class="p-4" style="overflow-x: auto; text-align: center; background: var(--bg-card);" id="algo-content">
            </div>
    </dialog>

    <dialog id="settings-modal">
        <div class="p-4">
            <h3>Emergency Numbers</h3>
            <div class="flex flex-col gap-4 mt-2">
                <input type="text" id="set-crash" placeholder="Crash Call (e.g. 2222)">
                <input type="text" id="set-obs" placeholder="Obs Reg (e.g. Bleep 1234)">
                <div class="flex justify-end gap-2 mt-2">
                    <button class="btn btn-outline" onclick="document.getElementById('settings-modal').close()">Close</button>
                    <button class="btn btn-primary" onclick="saveSettings()">Save</button>
                </div>
            </div>
        </div>
    </dialog>

    <script>
    // --- FULL DATASET ---
    const protocols = [
        {
            id: 'afe',
            name: 'Amniotic Fluid Embolism',
            steps: ['Call Help (2222)', 'CPR + LUD', 'Airway / Oxygen', 'Treat Coagulopathy (MHP)', 'Perimortem Section'],
            checklist: [
                'Recognise: Collapse + Hypoxia + Coagulopathy',
                'Call Help (Snr Obs, Anaes, Haem)',
                'Start CPR + Left Uterine Displacement',
                'Secure Airway (100% Oxygen)',
                'Activate MHP (Early FFP/Cryo)'
            ]
        },
        {
            id: 'abruption',
            name: 'Placental Abruption',
            steps: ['Assess (Pain + Bleeding)', 'Resus Mother (IV x2)', 'CTG Monitoring', 'Coag Screen', 'Category 1 Section'],
            checklist: [
                'Recognise: Painful bleeding, woody uterus',
                'Call Senior Help',
                'Maternal Resus: ABCDE, 2x Grey Cannulas',
                'Send FBC, G&S, Coag (Fibrinogen)',
                'Continuous CTG (if fetal heart present)',
                'Expedite Delivery (Cat 1 CS)'
            ]
        },
        {
            id: 'torsion',
            name: 'Ovarian Torsion',
            steps: ['Analgesia + Antiemetics', 'Pregnancy Test (-ve)', 'Urgent Gynae Review', 'Laparoscopy'],
            checklist: [
                'Recognise: Severe unilateral pain + Vomiting',
                'Perform Pregnancy Test (Exclude Ectopic)',
                'NBM + IV Fluids',
                'Urgent Gynae Referral',
                'Consent for Laparoscopy'
            ]
        },
        {
            id: 'pid',
            name: 'Severe PID / TOA',
            steps: ['Sepsis Screen', 'Admit Inpatient', 'IV Antibiotics', 'Gynae Review', 'Imaging'],
            checklist: [
                'Assess Severity (Sepsis/TOA/Pregnancy)',
                'Start IV Abx (Ceftriaxone + Doxy + Metro)',
                'Analgesia',
                'Gynae Consult for ?Drainage'
            ]
        },
        {
            id: 'preeclampsia',
            name: 'Pre-eclampsia / Eclampsia',
            steps: ['Call Help', 'Seizure: MgSO4 4g', 'BP: Labetalol/Hydralazine', 'Restrict Fluid', 'Deliver'],
            checklist: [
                'Call 2222 (Obstetric Emergency)',
                'Load MgSO4 4g IV (over 5-10 mins)',
                'Treat BP if >160/110 (Target 135/85)',
                'Fluid Restrict (80ml/hr)',
                'Monitor Reflexes & Resp Rate',
                'Urgent Delivery Plan'
            ]
        },
        {
            id: 'ectopic',
            name: 'Ruptured Ectopic',
            steps: ['Positive hCG + Shock', 'Call Help + MHP', 'IV Access x2', 'Immediate Theatre'],
            checklist: [
                'Recognise: +ve hCG, Peritonism, Shock',
                'Call Gynae + Anaesthetics STAT',
                'Activate Massive Haemorrhage Protocol',
                'Do NOT delay for Ultrasound',
                'Transfer to Theatre (Laparoscopy/Laparotomy)'
            ]
        },
        {
            id: 'pph',
            name: 'Post Partum Haemorrhage',
            steps: ['Call Help', 'Fundal Massage', 'Drugs (Synto/Ergo)', '4 Ts Check', 'MHP / Theatre'],
            checklist: [
                'Call 2222 if >1000ml or Shock',
                'Lie Flat + High flow Oxygen',
                'Mechanical: Fundal Massage / Bimanual',
                'Medical: Synto, Ergometrine, Carboprost, TXA',
                'Surgical: Exam Under Anaesthetic (EUA)'
            ],
            widget: 'pph'
        },
        {
            id: 'cord',
            name: 'Cord Prolapse',
            steps: ['Call Help', 'Elevate Presenting Part', 'Knee-Chest Position', 'Stop Syntocinon', 'Cat 1 Section'],
            checklist: [
                'Call Help (Cat 1 Section)',
                'Manual Elevation (gloved hand in vagina)',
                'Position: Knee-chest / Head down',
                'Tocolysis: Terbutaline 250mcg SC',
                'Do not remove hand until delivery'
            ]
        },
        {
            id: 'shoulder',
            name: 'Shoulder Dystocia',
            steps: ['Call Help', 'Episiotomy', 'Legs (McRoberts)', 'Pressure (Suprapubic)', 'Enter (Manoeuvres)', 'Remove Arm', 'Roll'],
            checklist: [
                'H: Help Called (Stop Pushing)',
                'E: Episiotomy considered',
                'L: Legs (McRoberts Manoeuvre)',
                'P: Suprapubic Pressure (Rocking)',
                'E: Enter (Rubin II / Woods Screw)',
                'R: Remove Posterior Arm',
                'R: Roll (All Fours)'
            ],
            widget: 'dystocia'
        },
        {
            id: 'breech',
            name: 'Breech Birth (Unexpected)',
            steps: ['Call Help', 'Hands Off', 'Spontaneous Descent', 'Loveset\'s Manoeuvre', 'Deliver Head (MSV)'],
            checklist: [
                'Call Senior Help (Obs + Paeds)',
                'Hands OFF until umbilicus visible',
                'Legs: Pinard Manoeuvre',
                'Arms: Loveset\'s Manoeuvre',
                'Head: Mauriceau-Smellie-Veit'
            ]
        },
        {
            id: 'cardiac',
            name: 'Obstetric Cardiac Arrest',
            steps: ['Call 2222', 'CPR + LUD', 'Assess Rhythm', '4 Mins: Hysterotomy', '5 Mins: Delivery'],
            checklist: [
                'Manual Left Uterine Displacement',
                'Intubate Early (High aspiration risk)',
                'IV Access above diaphragm',
                '4 Minute Rule: Prepare Hysterotomy',
                'Deliver baby to improve maternal outcome'
            ],
            widget: 'cardiac'
        }
    ];

    // --- APP STATE ---
    let currentId = 'afe';
    let logs = {};
    let pphVol = 0;

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        // Render Navigation
        const nav = document.getElementById('nav-container');
        protocols.forEach(p => {
            const btn = document.createElement('button');
            btn.className = 'nav-btn';
            btn.textContent = p.name;
            btn.onclick = () => loadProtocol(p.id);
            btn.id = `nav-${p.id}`;
            nav.appendChild(btn);
        });

        // Load First Protocol
        loadProtocol(protocols[0].id);
        
        // Search Listener
        document.getElementById('search-bar').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            protocols.forEach(p => {
                const btn = document.getElementById(`nav-${p.id}`);
                const match = p.name.toLowerCase().includes(term);
                btn.style.display = match ? 'inline-block' : 'none';
            });
        });

        // Checkbox Listener (Delegation)
        document.getElementById('content-area').addEventListener('change', (e) => {
            if(e.target.matches('.checkbox')) {
                const msg = e.target.getAttribute('data-msg');
                const action = e.target.checked ? '[DONE]' : '[UNDO]';
                logAction(currentId, `${action} ${msg}`);
            }
        });

        // Load Settings
        loadSettings();
        if(!localStorage.getItem('wmebem_accepted')) document.getElementById('disclaimer-modal').showModal();
        if(localStorage.getItem('wmebem_dark') === 'true') document.body.classList.add('dark');
    });

    // --- CORE RENDERER ---
    function loadProtocol(id) {
        currentId = id;
        const p = protocols.find(x => x.id === id);
        
        // Update Nav
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`nav-${id}`).classList.add('active');

        // Render Widgets
        let widgetHtml = '';
        if(p.widget === 'pph') widgetHtml = renderPPHWidget();
        if(p.widget === 'dystocia') widgetHtml = renderDystociaWidget();
        if(p.widget === 'cardiac') widgetHtml = renderCardiacWidget();

        // Render Checklists
        const checklistHtml = p.checklist.map((item, idx) => `
            <details>
                <summary>
                    <input type="checkbox" class="checkbox" data-msg="${item}">
                    ${item}
                    <span class="summary-arrow">‚ñ∂</span>
                </summary>
                <div class="p-4 text-sm bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
                    Action logged. See full guidance for details.
                </div>
            </details>
        `).join('');

        // Inject Content
        const area = document.getElementById('content-area');
        area.innerHTML = `
            ${widgetHtml}
            <div class="card p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-lg">${p.name}</h2>
                    <button class="btn btn-primary btn-sm" onclick="showAlgo('${id}')">View Algorithm</button>
                </div>
                ${checklistHtml}
            </div>
            <div class="card p-4 mt-4">
                <h4 class="font-bold text-sm text-muted mb-2">SESSION LOG</h4>
                <textarea id="log-area" class="h-40" readonly>${getLogText(id)}</textarea>
            </div>
        `;
    }

    // --- ALGORITHM GENERATOR (SVG) ---
    function showAlgo(id) {
        const p = protocols.find(x => x.id === id);
        const steps = p.steps;
        const modal = document.getElementById('algo-modal');
        const content = document.getElementById('algo-content');
        document.getElementById('algo-title').textContent = p.name + " Algorithm";

        // Dynamic SVG Generation
        const boxH = 50;
        const boxW = 220;
        const gap = 40;
        const svgH = (steps.length * (boxH + gap)) + 20;
        
        let svg = `<svg width="300" height="${svgH}" viewBox="0 0 300 ${svgH}" xmlns="http://www.w3.org/2000/svg">`;
        svg += `<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" class="flow-arrow" fill="currentColor" /></marker></defs>`;
        
        steps.forEach((step, i) => {
            const y = 20 + (i * (boxH + gap));
            svg += `<rect x="40" y="${y}" width="${boxW}" height="${boxH}" class="flow-box" />`;
            svg += `<text x="150" y="${y + 30}" class="flow-text">${step}</text>`;
            if (i < steps.length - 1) {
                svg += `<line x1="150" y1="${y + boxH}" x2="150" y2="${y + boxH + gap}" class="flow-arrow" />`;
            }
        });
        svg += `</svg>`;
        
        content.innerHTML = svg;
        modal.showModal();
    }

    // --- WIDGET RENDERERS ---
    function renderPPHWidget() {
        return `
        <div class="card p-4 mb-4" style="background:var(--danger-light); border-color:var(--danger);">
            <div class="flex justify-between items-end mb-2">
                <div><div class="text-xs font-bold text-danger uppercase">Total Blood Loss</div><div class="text-3xl font-mono font-bold text-danger" id="pph-total">${pphVol} ml</div></div>
                <button class="btn btn-outline btn-sm bg-white" onclick="resetPPH()">Reset</button>
            </div>
            <div class="flex gap-2">
                <button class="btn bg-white w-full border-danger text-danger" onclick="addPPH(100)">+100</button>
                <button class="btn btn-danger w-full font-bold" onclick="addPPH(500)">+500ml</button>
            </div>
        </div>`;
    }
    
    function renderDystociaWidget() {
        return `
        <div class="card p-4 mb-4 bg-warning-light border-warning">
             <div class="flex justify-between items-center">
                <div><div class="text-xs font-bold text-warning-dark uppercase">Head-to-Body Interval</div><div id="dystocia-time" class="text-2xl font-mono font-bold">00:00</div></div>
                <button id="btn-dystocia" class="btn btn-primary" onclick="toggleDystocia()">Start Timer</button>
             </div>
        </div>`;
    }

    function renderCardiacWidget() {
        return `
        <div class="timer-box">
            <div class="text-xs opacity-80 uppercase tracking-widest">Hysterotomy Timer</div>
            <div id="cardiac-time" class="timer-display">04:00</div>
            <div class="flex justify-center gap-2 mt-2">
                <button id="btn-cardiac" class="btn bg-white text-danger font-bold" onclick="toggleCardiac()">START</button>
                <button class="btn btn-outline text-white border-white hover:bg-white/10" onclick="resetCardiac()">Reset</button>
            </div>
        </div>`;
    }

    // --- TIMERS & LOGIC ---
    function logAction(id, msg) {
        if(!logs[id]) logs[id] = [];
        const time = new Date().toTimeString().substring(0,5);
        logs[id].push(`[${time}] ${msg}`);
        const area = document.getElementById('log-area');
        if(area) { area.value = logs[id].join('\n'); area.scrollTop = area.scrollHeight; }
    }
    function getLogText(id) { return logs[id] ? logs[id].join('\n') : ''; }
    function copyLog() { const area = document.getElementById('log-area'); if(area) { area.select(); document.execCommand('copy'); alert('Copied!'); } }

    // PPH Logic
    function addPPH(n) { pphVol += n; document.getElementById('pph-total').textContent = pphVol + ' ml'; logAction('pph', `EBL Updated: ${pphVol}ml (+${n})`); }
    function resetPPH() { pphVol = 0; document.getElementById('pph-total').textContent = '0 ml'; logAction('pph', 'EBL Reset'); }

    // Dystocia Timer
    let dysInt, dysSec = 0;
    function toggleDystocia() {
        const btn = document.getElementById('btn-dystocia');
        if(btn.textContent.includes('Start')) {
            btn.textContent = 'Stop'; btn.className = 'btn btn-danger';
            logAction('shoulder', 'Head Delivered. Timer Started.');
            dysInt = setInterval(() => { dysSec++; document.getElementById('dystocia-time').textContent = fmtTime(dysSec); }, 1000);
        } else {
            clearInterval(dysInt); btn.textContent = 'Start Timer'; btn.className = 'btn btn-primary';
            logAction('shoulder', 'Body Delivered. Interval: ' + fmtTime(dysSec)); dysSec = 0;
        }
    }

    // Cardiac Timer
    let carInt, carSec = 240;
    function toggleCardiac() {
        const btn = document.getElementById('btn-cardiac');
        if(btn.textContent === 'START') {
            initAudio(); btn.textContent = 'STOP'; logAction('cardiac', 'Cardiac Timer STARTED');
            carInt = setInterval(() => {
                carSec--; document.getElementById('cardiac-time').textContent = fmtTime(carSec);
                if(carSec === 30) beep(440);
                if(carSec === 0) { beep(880); clearInterval(carInt); logAction('cardiac', '4 MINUTE LIMIT REACHED'); }
            }, 1000);
        } else { clearInterval(carInt); btn.textContent = 'START'; logAction('cardiac', 'Timer PAUSED'); }
    }
    function resetCardiac() { clearInterval(carInt); carSec = 240; document.getElementById('cardiac-time').textContent = '04:00'; document.getElementById('btn-cardiac').textContent = 'START'; }

    // Fab Timer
    let fabInt, fabSec = 0;
    function toggleFabWidget() { document.getElementById('fab-timer-widget').classList.toggle('hidden'); }
    function runFabTimer() {
        const btn = document.getElementById('fab-timer-btn');
        if(btn.textContent === 'Start') {
            btn.textContent = 'Stop'; btn.className = 'btn btn-danger w-full';
            fabInt = setInterval(() => { fabSec++; document.getElementById('fab-timer-display').textContent = fmtTime(fabSec); }, 1000);
        } else { clearInterval(fabInt); fabSec = 0; btn.textContent = 'Start'; btn.className = 'btn btn-success w-full'; document.getElementById('fab-timer-display').textContent = '00:00'; }
    }

    // Utilities
    function fmtTime(s) { return new Date(s * 1000).toISOString().substring(14, 19); }
    let audioCtx; function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function beep(f) { if(audioCtx) { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value = f; o.start(); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5); o.stop(audioCtx.currentTime + 0.5); } }

    // Settings
    function openSettings() { document.getElementById('settings-modal').showModal(); }
    function saveSettings() {
        localStorage.setItem('wmebem_nums', JSON.stringify({ crash: document.getElementById('set-crash').value, obs: document.getElementById('set-obs').value }));
        loadSettings(); document.getElementById('settings-modal').close();
    }
    function loadSettings() {
        const d = JSON.parse(localStorage.getItem('wmebem_nums') || '{}');
        document.getElementById('set-crash').value = d.crash || ''; document.getElementById('set-obs').value = d.obs || '';
        const b = document.getElementById('numbers-bar'); b.innerHTML = '';
        if(d.crash) b.innerHTML += `<span style="background:#fecaca; color:#7f1d1d; padding:2px 6px; border-radius:4px;">Crash: ${d.crash}</span>`;
        if(d.obs) b.innerHTML += `<span style="background:#bfdbfe; color:#1e3a8a; padding:2px 6px; border-radius:4px;">Obs: ${d.obs}</span>`;
    }
    function toggleDark() { document.body.classList.toggle('dark'); localStorage.setItem('wmebem_dark', document.body.classList.contains('dark')); }
    function acceptDisclaimer() { localStorage.setItem('wmebem_accepted', 'true'); document.getElementById('disclaimer-modal').close(); }
    </script>
</body>
</html>
